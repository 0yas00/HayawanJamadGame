<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø­ÙŠÙˆØ§Ù† Ø¬Ù…Ø§Ø¯ Ù†Ø¨Ø§Øª</title>
  <link rel="stylesheet" href="style.css" />
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    .auth-container { width: 100%; max-width: 400px; margin: 80px auto; padding: 30px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
    .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
    .divider { margin: 25px 0; display: flex; align-items: center; text-align: center; color: #888; font-size: 14px; }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #eee; }
    .divider:not(:empty)::before { margin-left: .8em; }
    .divider:not(:empty)::after { margin-right: .8em; }
    .toggle-link { color: #3498db; cursor: pointer; text-decoration: none; margin-top: 15px; display: inline-block; font-size: 14px; }
    .toggle-link:hover { text-decoration: underline; }
    .main-btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
    .main-btn:hover { background: #219150; }
  </style>
</head>

<body>
  <div class="auth-container">
    <h2 id="auth-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹</h2>
    <p style="color:#7f8c8d; margin-bottom:25px;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</p>

    <div id="g_id_onload"
      data-client_id="150394320903-79ve7o5v80r87l4ko8807hq3erjlprc3.apps.googleusercontent.com"
      data-context="signin"
      data-ux_mode="popup"
      data-callback="handleCredentialResponse"
      data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline"
      data-text="signin_with" data-size="large" data-logo_alignment="left"></div>

    <div class="divider">Ø£Ùˆ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>

    <div id="manual-auth-form">
      <input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="auth-input">
      <input type="password" id="auth-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" class="auth-input">

      <div id="register-fields" style="display:none;">
        <input type="text" id="auth-username" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø±Ø© ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©" class="auth-input">
      </div>

      <button class="main-btn" id="btn-login" onclick="manualLogin()">Ø¯Ø®ÙˆÙ„</button>
      <button class="main-btn" id="btn-register" style="display:none;" onclick="manualRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>

      <span class="toggle-link" id="toggle-auth" onclick="toggleAuthMode(true)">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</span>
      <span class="toggle-link" id="toggle-back" style="display:none;" onclick="toggleAuthMode(false)">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</span>
    </div>
  </div>

  <script>
    const socket = io();

    window.onload = () => {
      const savedEmail = localStorage.getItem('userEmail');
      const savedName = localStorage.getItem('gameUsername');
      if (savedEmail && savedName) window.location.href = 'lobby.html';
    };

    function toggleAuthMode(isRegister) {
      document.getElementById('auth-title').innerText = isRegister ? "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" : "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹";
      document.getElementById('register-fields').style.display = isRegister ? "block" : "none";
      document.getElementById('btn-register').style.display = isRegister ? "block" : "none";
      document.getElementById('btn-login').style.display = isRegister ? "none" : "block";
      document.getElementById('toggle-auth').style.display = isRegister ? "none" : "block";
      document.getElementById('toggle-back').style.display = isRegister ? "block" : "none";
    }

    function manualLogin() {
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      socket.emit('login_request', { email, password });
    }

    function manualRegister() {
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      const username = document.getElementById('auth-username').value;
      socket.emit('register_request', { email, password, username });
    }

    function handleCredentialResponse(response) {
      socket.emit('google_login', { token: response.credential });
    }

    socket.on('auth_success', (data) => {
      localStorage.setItem('userEmail', data.email);

      if (data.username) {
        localStorage.setItem('gameUsername', data.username);
        window.location.href = 'lobby.html';
      } else {
        // Ù…Ø³ØªØ®Ø¯Ù… Ø¬ÙˆØ¬Ù„ Ø¬Ø¯ÙŠØ¯: Ù†Ø®Ù„ÙŠÙ‡ ÙŠØ±ÙˆØ­ lobby.html Ø¹Ø´Ø§Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        localStorage.setItem('tempUserEmail', data.email);
        window.location.href = 'lobby.html';
      }
    });

    socket.on('auth_error', (data) => alert(data.message));
  </script>
</body>
</html>
