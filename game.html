<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ù„Ø¹Ø¨ - Ø­ÙŠÙˆØ§Ù† Ø¬Ù…Ø§Ø¯ Ù†Ø¨Ø§Øª</title>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>

  <style>
    .game-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:10px 0; border-bottom:2px solid #ddd; }
    #timer { font-size:40px; font-weight:bold; color:#e74c3c; border:3px solid #e74c3c; padding:10px 20px; border-radius:10px; background-color:#ffeaea; }
    .challenge-letter { font-size:50px; color:#2c3e50; font-weight:900; }
    .answer-grid { display:grid; grid-template-columns:repeat(2, 1fr); gap:20px; margin-bottom:30px; }
    .answer-box { background-color:#ecf0f1; padding:15px; border-radius:8px; position:relative; }
    .answer-box label { display:block; font-weight:bold; margin-bottom:8px; color:#2980b9; font-size:18px; }
    .answer-box input { width:100%; padding:10px; border:1px solid #bdc3c7; border-radius:5px; text-align:right; }
    .feedback-icon { position:absolute; top:15px; left:15px; font-size:20px; display:none; }

    #stop-btn { background-color:#f39c12; color:white; border:none; padding:15px; border-radius:8px; font-size:22px; width:100%; cursor:pointer; }
    #system-message { margin-top:20px; padding:15px; border-radius:8px; display:none; text-align:center; font-weight:bold; }

    #pre-game-overlay {
      position:fixed; inset:0;
      background:rgba(0,0,0,0.9); color:white;
      display:none; flex-direction:column;
      align-items:center; justify-content:center;
      font-size:120px; z-index:9999;
    }
  </style>
</head>

<body>

<div id="pre-game-overlay">
  <div id="countdown-number">3</div>
  <div style="font-size:30px;">Ø§Ø³ØªØ¹Ø¯...</div>
</div>

<div class="lobby-container">
  <div id="system-message"></div>

  <div class="game-header">
    <div>
      <div>Ø§Ù„Ø­Ø±Ù Ø§Ù„Ù…Ø®ØµØµ:</div>
      <div class="challenge-letter" id="current-letter">?</div>
    </div>
    <div id="timer">00:00</div>
  </div>

  <div class="answer-grid">
    <div class="answer-box"><label>Ø­ÙŠÙˆØ§Ù† <span id="mark-Ø­ÙŠÙˆØ§Ù†" class="feedback-icon"></span></label><input id="Ø­ÙŠÙˆØ§Ù†"></div>
    <div class="answer-box"><label>Ø¬Ù…Ø§Ø¯ <span id="mark-Ø¬Ù…Ø§Ø¯" class="feedback-icon"></span></label><input id="Ø¬Ù…Ø§Ø¯"></div>
    <div class="answer-box"><label>Ù†Ø¨Ø§Øª <span id="mark-Ù†Ø¨Ø§Øª" class="feedback-icon"></span></label><input id="Ù†Ø¨Ø§Øª"></div>
    <div class="answer-box"><label>Ø¨Ù„Ø§Ø¯ <span id="mark-Ø¨Ù„Ø§Ø¯" class="feedback-icon"></span></label><input id="Ø¨Ù„Ø§Ø¯"></div>
    <div class="answer-box" style="grid-column:span 2"><label>Ø§Ø³Ù… <span id="mark-Ø§Ø³Ù…" class="feedback-icon"></span></label><input id="Ø§Ø³Ù…"></div>
  </div>

  <button id="stop-btn" onclick="handleStop()">ØªÙˆÙ‚Ù</button>
</div>

<script>
const socket = io();
const ROOM_CODE = new URLSearchParams(location.search).get("roomCode");
const playerName = localStorage.getItem("gameUsername");
const isCreator = localStorage.getItem("isCreator") === "true";

if (!ROOM_CODE || !playerName) location.href = "index.html";

let timeRemaining = 0;
let timerInterval;
let gameRunning = false;
let currentLetter = "";

function toggleInputs(disabled) {
  document.querySelectorAll("input").forEach(i => i.disabled = disabled);
}

function msg(text, color="#2980b9") {
  const m = document.getElementById("system-message");
  m.textContent = text;
  m.style.background = color;
  m.style.display = "block";
}

socket.on("connect", () => {
  socket.emit("identify_player", { roomCode: ROOM_CODE, playerName });

  if (isCreator) {
    socket.emit("start_game", { roomCode: ROOM_CODE, playerName });
  }
});

socket.on("pre_game_countdown", n => {
  document.getElementById("pre-game-overlay").style.display = "flex";
  document.getElementById("countdown-number").textContent = n === 0 ? "Ø§Ø¨Ø¯Ø£!" : n;
});

socket.on("game_actually_started", data => {
  document.getElementById("pre-game-overlay").style.display = "none";
  currentLetter = data.letter;
  timeRemaining = data.time;
  document.getElementById("current-letter").textContent = currentLetter;
  gameRunning = true;
  toggleInputs(false);
  startTimer();
});

function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (!gameRunning) return;
    if (timeRemaining <= 0) {
      handleStop(true);
      return;
    }
    timeRemaining--;
    document.getElementById("timer").textContent =
      `00:${String(timeRemaining).padStart(2,"0")}`;
  }, 1000);
}

function handleStop(auto=false) {
  if (!gameRunning && !auto) return;
  socket.emit("stop_game_request", {
    roomCode: ROOM_CODE,
    playerName,
    currentLetter,
    answers: {
      Ø­ÙŠÙˆØ§Ù†: Ø­ÙŠÙˆØ§Ù†.value,
      Ø¬Ù…Ø§Ø¯: Ø¬Ù…Ø§Ø¯.value,
      Ù†Ø¨Ø§Øª: Ù†Ø¨Ø§Øª.value,
      Ø¨Ù„Ø§Ø¯: Ø¨Ù„Ø§Ø¯.value,
      Ø§Ø³Ù…: Ø§Ø³Ù….value
    }
  });
  msg("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...");
}

socket.on("stop_failed", d => {
  msg(d.message, "#f39c12");
  gameRunning = true;        // ğŸ‘ˆ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©
});

socket.on("player_won_match", d => {
  gameRunning = false;
  toggleInputs(true);
  msg(d.winner === playerName ? "ğŸ‰ ÙØ²Øª!" : `ğŸ† Ø§Ù„ÙØ§Ø¦Ø²: ${d.winner}`, "#27ae60");
});

socket.on("ai_correction", r => {
  for (const k in r) {
    const el = document.getElementById("mark-" + k);
    el.textContent = r[k] === "ØµØ­" ? "âœ…" : "âŒ";
    el.style.display = "inline";
  }
});

toggleInputs(true);
</script>
</body>
</html>
