<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ù„Ø¹Ø¨ - Ø­ÙŠÙˆØ§Ù† Ø¬Ù…Ø§Ø¯ Ù†Ø¨Ø§Øª</title>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>

  <style>
    .game-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:10px 0; border-bottom:2px solid #ddd; }
    #timer { font-size:40px; font-weight:bold; color:#e74c3c; border:3px solid #e74c3c; padding:10px 20px; border-radius:10px; background-color:#ffeaea; }
    .challenge-letter { font-size:50px; color:#2c3e50; font-weight:900; }
    .answer-grid { display:grid; grid-template-columns:repeat(2, 1fr); gap:20px; margin-bottom:30px; }
    .answer-box { background-color:#ecf0f1; padding:15px; border-radius:8px; position:relative; }
    .answer-box label { display:block; font-weight:bold; margin-bottom:8px; color:#2980b9; font-size:18px; }
    .answer-box input { width:100%; padding:10px; border:1px solid #bdc3c7; border-radius:5px; box-sizing:border-box; text-align:right; }
    .feedback-icon { position:absolute; top:15px; left:15px; font-size:20px; display:none; }

    #stop-btn { background-color:#f39c12; color:white; border:none; padding:15px 30px; border-radius:8px; cursor:pointer; font-size:22px; width:100%; }
    #system-message { margin-top:20px; padding:15px; border-radius:8px; display:none; text-align:center; font-weight:bold; font-size:1.2em; }

    #pre-game-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.9); color:white; display:none;
      flex-direction:column; align-items:center; justify-content:center;
      font-size:120px; font-weight:bold; z-index:9999;
    }
  </style>
</head>

<body>
  <div id="pre-game-overlay">
    <div id="countdown-number">3</div>
    <div style="font-size:30px; margin-top:20px;">Ø§Ø³ØªØ¹Ø¯...</div>
  </div>

  <div class="lobby-container">
    <div id="system-message"></div>

    <div class="game-header">
      <div>
        <div style="font-size:20px; color:#7f8c8d;">Ø§Ù„Ø­Ø±Ù Ø§Ù„Ù…Ø®ØµØµ:</div>
        <div class="challenge-letter" id="current-letter">?</div>
      </div>
      <div id="timer">00:00</div>
    </div>

    <div class="answer-grid">
      <div class="answer-box">
        <label>Ø­ÙŠÙˆØ§Ù†: <span id="mark-Ø­ÙŠÙˆØ§Ù†" class="feedback-icon"></span></label>
        <input type="text" id="Ø­ÙŠÙˆØ§Ù†" placeholder="Ø£Ø¯Ø®Ù„ Ø­ÙŠÙˆØ§Ù†">
      </div>
      <div class="answer-box">
        <label>Ø¬Ù…Ø§Ø¯: <span id="mark-Ø¬Ù…Ø§Ø¯" class="feedback-icon"></span></label>
        <input type="text" id="Ø¬Ù…Ø§Ø¯" placeholder="Ø£Ø¯Ø®Ù„ Ø¬Ù…Ø§Ø¯">
      </div>
      <div class="answer-box">
        <label>Ù†Ø¨Ø§Øª: <span id="mark-Ù†Ø¨Ø§Øª" class="feedback-icon"></span></label>
        <input type="text" id="Ù†Ø¨Ø§Øª" placeholder="Ø£Ø¯Ø®Ù„ Ù†Ø¨Ø§Øª">
      </div>
      <div class="answer-box">
        <label>Ø¨Ù„Ø§Ø¯: <span id="mark-Ø¨Ù„Ø§Ø¯" class="feedback-icon"></span></label>
        <input type="text" id="Ø¨Ù„Ø§Ø¯" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ù„Ø§Ø¯">
      </div>
      <div class="answer-box" style="grid-column: span 2; max-width:50%; margin:0 auto;">
        <label>Ø§Ø³Ù…: <span id="mark-Ø§Ø³Ù…" class="feedback-icon"></span></label>
        <input type="text" id="Ø§Ø³Ù…" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…">
      </div>
    </div>

    <button id="stop-btn" onclick="handleStopGame()">ØªÙˆÙ‚Ù</button>
  </div>

  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const ROOM_CODE = urlParams.get('roomCode');
    const playerName = localStorage.getItem('gameUsername') || '';

    if (!playerName || !ROOM_CODE) {
      window.location.href = 'index.html';
    }

    let timerInterval;
    let timeRemaining = 0;
    let gameRunning = false;
    let currentLetter = '';

    function toggleInputs(disabled) {
      document.querySelectorAll('.answer-grid input').forEach(input => input.disabled = disabled);
    }

    function displaySystemMessage(message, color) {
      const sysMsg = document.getElementById('system-message');
      sysMsg.innerHTML = message;
      sysMsg.style.backgroundColor = color;
      sysMsg.style.display = 'block';
    }

   socket.on('connect', () => {
  socket.emit('identify_player', {
    roomCode: ROOM_CODE,
    playerName: playerName
  });

  // â­ï¸ Ø§Ø·Ù„Ø¨ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ù‡Ù†Ø§ (Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØºØ±ÙØ©)
  socket.emit('start_game', {
    roomCode: ROOM_CODE,
    playerName: playerName
  });
});

    // Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
    socket.on('pre_game_countdown', (count) => {
      const overlay = document.getElementById('pre-game-overlay');
      const num = document.getElementById('countdown-number');
      overlay.style.display = 'flex';
      num.textContent = count === 0 ? "Ø§Ø¨Ø¯Ø£!" : count;
    });

    // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø©
    socket.on('game_actually_started', (data) => {
      setTimeout(() => {
        document.getElementById('pre-game-overlay').style.display = 'none';
      }, 1000);

      currentLetter = data.letter;
      document.getElementById('current-letter').textContent = currentLetter;

      timeRemaining = data.time;
      gameRunning = true;

      toggleInputs(false);
      startTimer();
    });

    function startTimer() {
      clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        if (timeRemaining > 0 && gameRunning) {
          timeRemaining--;
          const minutes = Math.floor(timeRemaining / 60);
          const seconds = timeRemaining % 60;
          document.getElementById('timer').textContent =
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        } else if (timeRemaining <= 0 && gameRunning) {
          clearInterval(timerInterval);
          handleStopGame(true);
        }
      }, 1000);
    }

    // ØªØµØ­ÙŠØ­ AI
    socket.on('ai_correction', (results) => {
      for (const [category, status] of Object.entries(results)) {
        const mark = document.getElementById(`mark-${category}`);
        if (mark) {
          mark.textContent = status === "ØµØ­" ? "âœ…" : "âŒ";
          mark.style.color = status === "ØµØ­" ? "#27ae60" : "#e74c3c";
          mark.style.display = 'inline';
        }
      }
    });

    // Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø²
    socket.on('player_won_match', (data) => {
      gameRunning = false;
      clearInterval(timerInterval);
      toggleInputs(true);
      document.getElementById('stop-btn').disabled = true;

      const msg = (data.winner === playerName)
        ? `ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£Ù†Øª Ø§Ù„ÙØ§Ø¦Ø²`
        : `ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: ${data.winner}`;

      displaySystemMessage(msg, data.winner === playerName ? '#27ae60' : '#c0392b');
    });

    function collectAnswers() {
      return {
        Ø­ÙŠÙˆØ§Ù†: document.getElementById('Ø­ÙŠÙˆØ§Ù†').value.trim(),
        Ø¬Ù…Ø§Ø¯: document.getElementById('Ø¬Ù…Ø§Ø¯').value.trim(),
        Ù†Ø¨Ø§Øª: document.getElementById('Ù†Ø¨Ø§Øª').value.trim(),
        Ø¨Ù„Ø§Ø¯: document.getElementById('Ø¨Ù„Ø§Ø¯').value.trim(),
        Ø§Ø³Ù…: document.getElementById('Ø§Ø³Ù…').value.trim(),
      };
    }

    function handleStopGame(isAuto = false) {
      if (!gameRunning && !isAuto) return;

      gameRunning = false;
      document.getElementById('stop-btn').disabled = true;

      socket.emit('stop_game_request', {
        roomCode: ROOM_CODE,
        playerName: playerName,
        answers: collectAnswers(),
        currentLetter: currentLetter
      });

      displaySystemMessage(
        isAuto ? "â³ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øªâ€¦ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚!" : "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ...",
        '#2980b9'
      );
    }

    socket.on('stop_failed', (data) => {
      document.getElementById('stop-btn').disabled = false;
      gameRunning = true;
      displaySystemMessage(data.message, '#f39c12');
    });

    socket.on('room_error', (data) => {
      alert(data.message);
      window.location.href = 'index.html';
    });

    // Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    toggleInputs(true);
  </script>
</body>
</html>
