<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù„Ø¹Ø¨ - Ø­ÙŠÙˆØ§Ù† Ø¬Ù…Ø§Ø¯ Ù†Ø¨Ø§Øª</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (ØªÙ… ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ CSS) */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 2px solid #ddd;
        }

        #timer {
            font-size: 40px;
            font-weight: bold;
            color: #e74c3c;
            border: 3px solid #e74c3c;
            padding: 10px 20px;
            border-radius: 10px;
            background-color: #ffeaea;
        }

        .challenge-letter {
            font-size: 50px;
            color: #2c3e50;
            font-weight: 900;
        }

        .answer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .answer-box {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
        }

        .answer-box label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2980b9;
            font-size: 18px;
        }

        .answer-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: right;
        }

        #stop-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 22px;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        #stop-btn:hover:not(:disabled) {
            background-color: #e67e22;
        }
        #stop-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        /* Ù„ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ÙˆØ¶ÙˆØ­ */
        #system-message {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0ad4e;
            color: white;
            border-radius: 5px;
            display: none;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="lobby-container">
        
        <div id="system-message"></div>

        <div class="game-header">
            <div>
                <div style="font-size: 20px; color: #7f8c8d;">Ø§Ù„Ø­Ø±Ù Ø§Ù„Ù…Ø®ØµØµ:</div>
                <div class="challenge-letter" id="current-letter">?</div> 
            </div>
            <div id="timer">01:00</div>
        </div>

        <div class="answer-grid">
            <div class="answer-box"><label for="Ø­ÙŠÙˆØ§Ù†">Ø­ÙŠÙˆØ§Ù†:</label><input type="text" id="Ø­ÙŠÙˆØ§Ù†" data-category="Ø­ÙŠÙˆØ§Ù†" placeholder="Ø£Ø¯Ø®Ù„ Ø­ÙŠÙˆØ§Ù†"></div>
            <div class="answer-box"><label for="Ø¬Ù…Ø§Ø¯">Ø¬Ù…Ø§Ø¯:</label><input type="text" id="Ø¬Ù…Ø§Ø¯" data-category="Ø¬Ù…Ø§Ø¯" placeholder="Ø£Ø¯Ø®Ù„ Ø¬Ù…Ø§Ø¯"></div>
            <div class="answer-box"><label for="Ù†Ø¨Ø§Øª">Ù†Ø¨Ø§Øª:</label><input type="text" id="Ù†Ø¨Ø§Øª" data-category="Ù†Ø¨Ø§Øª" placeholder="Ø£Ø¯Ø®Ù„ Ù†Ø¨Ø§Øª"></div>
            <div class="answer-box"><label for="Ø¨Ù„Ø§Ø¯">Ø¨Ù„Ø§Ø¯:</label><input type="text" id="Ø¨Ù„Ø§Ø¯" data-category="Ø¨Ù„Ø§Ø¯" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ù„Ø§Ø¯"></div>
            <div class="answer-box" style="grid-column: span 2; max-width: 50%; margin: 0 auto;"><label for="Ø§Ø³Ù…">Ø§Ø³Ù… (Ø´Ø®Øµ):</label><input type="text" id="Ø§Ø³Ù…" data-category="Ø§Ø³Ù…" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…"></div>
        </div>

        <button id="stop-btn" onclick="handleStopGame()">ØªÙˆÙ‚Ù</button>
    </div>

    <script>
        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ±Ø§Øª (Parameters) Ù…Ù† Ø±Ø§Ø¨Ø· URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // ------------------------------------------------------------------

        // Ù‚Ø±Ø§Ø¡Ø© Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø±Ø§Ø¨Ø· URL Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† localStorage
        const ROOM_CODE = getUrlParameter('roomCode');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ù…Ø² Ù…ÙˆØ¬ÙˆØ¯
        if (!ROOM_CODE || ROOM_CODE.length !== 6) {
            alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„Ù„ÙˆØ¨ÙŠ.');
            window.location.href = 'lobby.html';
        }
        
        let timerInterval;
        let timeRemaining = 60; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…)
        let gameRunning = true;
        let currentLetter = ''; 
        
        const playerName = localStorage.getItem('gameUsername') || 'Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„';
        
        const socket = io();

        // ----------------- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ------------------

        // Ø¯Ø§Ù„Ø© Ù„ØªØ¹Ø·ÙŠÙ„ / ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        function toggleInputs(disabled) {
            document.querySelectorAll('.answer-grid input').forEach(input => {
                input.disabled = disabled;
            });
        }

        function displaySystemMessage(message, color) {
            const sysMsg = document.getElementById('system-message');
            sysMsg.innerHTML = message; // Ø§Ø³ØªØ®Ø¯Ø§Ù… innerHTML Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù€ bold Ùˆ emoji
            sysMsg.style.backgroundColor = color;
            sysMsg.style.display = 'block';
            setTimeout(() => {
                sysMsg.style.display = 'none';
            }, 5000); 
        }

        function updateLetterDisplay(letter) {
            document.getElementById('current-letter').textContent = letter;
            document.querySelectorAll('.answer-box input').forEach(input => {
                const category = input.getAttribute('data-category');
                input.placeholder = `Ø£Ø¯Ø®Ù„ ${category} Ø¨Ø­Ø±Ù ${letter}`;
            });
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function startTimer() {
            // Ù…Ø³Ø­ Ø£ÙŠ Ù…Ø¤Ù‚Øª Ø³Ø§Ø¨Ù‚ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØ¶Ø§Ø±Ø¨
            clearInterval(timerInterval); 
            
            timerInterval = setInterval(() => {
                if (timeRemaining > 0 && gameRunning) {
                    timeRemaining--;
                    updateTimerDisplay();
                } else if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    gameRunning = false;
                    toggleInputs(true); // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„
                    document.getElementById('stop-btn').disabled = true;
                    displaySystemMessage("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ.", '#dc3545'); 
                }
            }, 1000); 
        }

        function getPlayerAnswers() {
            const categories = ['Ø§Ø³Ù…', 'Ø­ÙŠÙˆØ§Ù†', 'Ù†Ø¨Ø§Øª', 'Ø¬Ù…Ø§Ø¯', 'Ø¨Ù„Ø§Ø¯'];
            const answers = {};
            categories.forEach(cat => {
                const inputElement = document.getElementById(cat);
                answers[cat] = inputElement ? inputElement.value.trim() : '';
            });
            return answers;
        }

        // ----------------- Socket Listeners ------------------
        
        socket.on('connect', () => {
            console.log(`Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ Ø§Ù„ØºØ±ÙØ©: ${ROOM_CODE}`);
            // Ø·Ù„Ø¨ Ø§Ù„Ø­Ø±Ù (Ø§Ù„Ø°ÙŠ Ø³ÙŠØ±Ø³Ù„ Ø§Ù„Ø­Ø±Ù ÙˆÙˆÙ‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯)
            requestGameLetter(); 
        });

        // Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ø­Ø±Ù Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨
        function requestGameLetter() {
            socket.emit('get_room_letter', ROOM_CODE);
            document.getElementById('current-letter').textContent = '?';
            toggleInputs(true); // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­ØªÙ‰ ÙŠØ£ØªÙŠ Ø§Ù„Ø­Ø±Ù ÙˆØ§Ù„ÙˆÙ‚Øª
        }

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø±Ø¯ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ø§Ù„Ø­Ø±Ù ÙˆØ§Ù„ÙˆÙ‚Øª
        socket.on('room_letter', (data) => {
            if (data.currentLetter) {
                // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø±Ù
                updateLetterDisplay(data.currentLetter); 
                currentLetter = data.currentLetter;
                
                // 2. ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
                timeRemaining = data.roundTime; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                updateTimerDisplay(); 
                startTimer();
                
                // 3. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨
                toggleInputs(false); 
            }
        });
        
        // Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ØªØ²Ø§Ù…Ù† Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ø¨Ù…Ø§ ÙÙŠÙ‡Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ Ø¶ØºØ· Ø¹Ù„Ù‰ ØªÙˆÙ‚Ù)
        socket.on('time_stopped', (data) => {
            if (gameRunning) {
                clearInterval(timerInterval); 
                gameRunning = false;
                
                // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø²Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹
                toggleInputs(true); 
                document.getElementById('stop-btn').disabled = true;
                
                // Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø§Ù„Ø¬ÙˆÙ„Ø©
                const announcement = `ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø§Ù„Ø¬ÙˆÙ„Ø©: **${data.stopper}**!`;
                displaySystemMessage(announcement, '#00bfa5'); 
            }
        });
        
        socket.on('stop_failed', (data) => {
            // Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ°Ù‡Ø¨ ÙÙ‚Ø· Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ Ø£ÙˆÙ‚Ù Ø§Ù„Ù„Ø¹Ø¨ ÙˆÙØ´Ù„Øª Ø¥Ø¬Ø§Ø¨ØªÙ‡
            displaySystemMessage(data.message, '#f0ad4e');
            gameRunning = true;
            document.getElementById('stop-btn').disabled = false;
            startTimer(); // Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨
        });

        // ----------------- ÙˆØ¸ÙŠÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± "ØªÙˆÙ‚Ù" ------------------

        function handleStopGame() {
            if (!gameRunning || !currentLetter) return;

            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù…Ø¤Ù‚ØªØ§Ù‹) ÙˆØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
            clearInterval(timerInterval);
            document.getElementById('stop-btn').disabled = true; 

            const answers = getPlayerAnswers();

            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
            socket.emit('stop_game_request', { 
                roomCode: ROOM_CODE, 
                playerName: playerName,
                answers: answers, 
                currentLetter: currentLetter 
            });

            displaySystemMessage("Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...", '#007bff');
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (ÙŠØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø±Ù ÙˆØ§Ù„ÙˆÙ‚Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…)
        window.onload = function() {
            // ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ requestGameLetter Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Socket.io Ù„Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨
            updateTimerDisplay(); // Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø£ÙˆÙ„ÙŠ (01:00) Ù…Ø¤Ù‚ØªØ§Ù‹
        };
    </script>
</body>
</html>