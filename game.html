<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù„Ø¹Ø¨ - Ø­ÙŠÙˆØ§Ù† Ø¬Ù…Ø§Ø¯ Ù†Ø¨Ø§Øª</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (ÙƒÙ…Ø§ Ù‡ÙŠ) */
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0; border-bottom: 2px solid #ddd; }
        #timer { font-size: 40px; font-weight: bold; color: #e74c3c; border: 3px solid #e74c3c; padding: 10px 20px; border-radius: 10px; background-color: #ffeaea; }
        .challenge-letter { font-size: 50px; color: #2c3e50; font-weight: 900; }
        .answer-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .answer-box { background-color: #ecf0f1; padding: 15px; border-radius: 8px; }
        .answer-box label { display: block; font-weight: bold; margin-bottom: 8px; color: #2980b9; font-size: 18px; }
        .answer-box input { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; box-sizing: border-box; text-align: right; }
        #stop-btn { background-color: #f39c12; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 22px; transition: background-color 0.3s ease; width: 100%; }
        #stop-btn:hover:not(:disabled) { background-color: #e67e22; }
        #stop-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        #system-message { margin-top: 20px; padding: 10px; background-color: #f0ad4e; color: white; border-radius: 5px; display: none; text-align: center; }
    </style>
</head>
<body>
    <div class="lobby-container">
        <div id="system-message"></div>

        <div class="game-header">
            <div>
                <div style="font-size: 20px; color: #7f8c8d;">Ø§Ù„Ø­Ø±Ù Ø§Ù„Ù…Ø®ØµØµ:</div>
                <div class="challenge-letter" id="current-letter">?</div> 
            </div>
            <div id="timer">01:00</div>
        </div>

        <div class="answer-grid">
            <div class="answer-box"><label for="Ø­ÙŠÙˆØ§Ù†">Ø­ÙŠÙˆØ§Ù†:</label><input type="text" id="Ø­ÙŠÙˆØ§Ù†" data-category="Ø­ÙŠÙˆØ§Ù†" placeholder="Ø£Ø¯Ø®Ù„ Ø­ÙŠÙˆØ§Ù†"></div>
            <div class="answer-box"><label for="Ø¬Ù…Ø§Ø¯">Ø¬Ù…Ø§Ø¯:</label><input type="text" id="Ø¬Ù…Ø§Ø¯" data-category="Ø¬Ù…Ø§Ø¯" placeholder="Ø£Ø¯Ø®Ù„ Ø¬Ù…Ø§Ø¯"></div>
            <div class="answer-box"><label for="Ù†Ø¨Ø§Øª">Ù†Ø¨Ø§Øª:</label><input type="text" id="Ù†Ø¨Ø§Øª" data-category="Ù†Ø¨Ø§Øª" placeholder="Ø£Ø¯Ø®Ù„ Ù†Ø¨Ø§Øª"></div>
            <div class="answer-box"><label for="Ø¨Ù„Ø§Ø¯">Ø¨Ù„Ø§Ø¯:</label><input type="text" id="Ø¨Ù„Ø§Ø¯" data-category="Ø¨Ù„Ø§Ø¯" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ù„Ø§Ø¯"></div>
            <div class="answer-box" style="grid-column: span 2; max-width: 50%; margin: 0 auto;"><label for="Ø§Ø³Ù…">Ø§Ø³Ù… (Ø´Ø®Øµ):</label><input type="text" id="Ø§Ø³Ù…" data-category="Ø§Ø³Ù…" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…"></div>
        </div>

        <button id="stop-btn" onclick="handleStopGame()">ØªÙˆÙ‚Ù</button>
    </div>

    <script>
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        const ROOM_CODE = getUrlParameter('roomCode');
        const playerName = localStorage.getItem('gameUsername') || 'Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„';
        
        if (!ROOM_CODE) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù…Ø²!');
            window.location.href = 'index.html';
        }

        let timerInterval;
        let timeRemaining = 60;
        let gameRunning = true;
        let currentLetter = ''; 
        
        const socket = io();

        // ----------------- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ------------------
        function toggleInputs(disabled) {
            document.querySelectorAll('.answer-grid input').forEach(input => { input.disabled = disabled; });
        }

        function displaySystemMessage(message, color) {
            const sysMsg = document.getElementById('system-message');
            sysMsg.innerHTML = message;
            sysMsg.style.backgroundColor = color;
            sysMsg.style.display = 'block';
        }

        function updateLetterDisplay(letter) {
            document.getElementById('current-letter').textContent = letter;
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (timeRemaining > 0 && gameRunning) {
                    timeRemaining--;
                    const minutes = Math.floor(timeRemaining / 60);
                    const seconds = timeRemaining % 60;
                    document.getElementById('timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    toggleInputs(true);
                }
            }, 1000);
        }

        // ----------------- Socket Listeners ------------------
        socket.on('connect', () => {
            socket.emit('get_room_letter', ROOM_CODE);
        });

        socket.on('room_letter', (data) => {
            currentLetter = data.currentLetter;
            updateLetterDisplay(currentLetter);
            timeRemaining = data.roundTime;
            startTimer();
            toggleInputs(false);
        });

       socket.on('time_stopped', (data) => {
            gameRunning = false;
            clearInterval(timerInterval);
            toggleInputs(true);
            document.getElementById('stop-btn').disabled = true;

            // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ù„Ø¶Ù…Ø§Ù† Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø§Ø³Ù… Ø¨Ø¯Ù‚Ø© ---
            if (data.stopper === playerName) {
                displaySystemMessage(`ğŸ‰ Ø£Ø­Ø³Ù†Øª ÙŠØ§ ${playerName}! ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ²Ùƒ ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ.`, '#27ae60');
                // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø³ÙŠØ±ÙØ±
                socket.emit('update_winner_score', { playerName: playerName });
            } else {
                displaySystemMessage(`ğŸ›‘ ØªÙˆÙ‚Ù Ø§Ù„Ù„Ø¹Ø¨! Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: ${data.stopper}`, '#c0392b');
            }
        });

            // --- Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Øª Ø§Ù„ÙØ§Ø¦Ø²ØŒ Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
            if (data.stopper === playerName) {
                displaySystemMessage(`ğŸ‰ Ø£Ø­Ø³Ù†Øª ÙŠØ§ ${playerName}! ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ²Ùƒ ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ.`, '#27ae60');
                socket.emit('update_winner_score', { playerName: playerName });
            } else {
                displaySystemMessage(`ğŸ›‘ ØªÙˆÙ‚Ù Ø§Ù„Ù„Ø¹Ø¨! Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: ${data.stopper}`, '#c0392b');
            }
        });

        socket.on('stop_failed', (data) => {
            displaySystemMessage(data.message, '#f39c12');
            document.getElementById('stop-btn').disabled = false;
        });

        function handleStopGame() {
            if (!gameRunning) return;
            const answers = {
                Ø§Ø³Ù…: document.getElementById('Ø§Ø³Ù…').value,
                Ø­ÙŠÙˆØ§Ù†: document.getElementById('Ø­ÙŠÙˆØ§Ù†').value,
                Ù†Ø¨Ø§Øª: document.getElementById('Ù†Ø¨Ø§Øª').value,
                Ø¬Ù…Ø§Ø¯: document.getElementById('Ø¬Ù…Ø§Ø¯').value,
                Ø¨Ù„Ø§Ø¯: document.getElementById('Ø¨Ù„Ø§Ø¯').value
            };
            socket.emit('stop_game_request', { 
                roomCode: ROOM_CODE, 
                playerName: playerName, 
                answers: answers, 
                currentLetter: currentLetter 
            });
        }
    </script>
</body>
</html>