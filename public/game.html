<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ุงููุนุจ - ุญููุงู ุฌูุงุฏ ูุจุงุช</title>

  <!-- CSS -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/game.css">

  <!-- Socket -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- ููู ููุฌูุงู -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<!-- ุนุฏูุงุฏ ุงูุจุฏุงูุฉ -->
<div id="pre-game-overlay">
  <div id="countdown-number">3</div>
  <div class="overlay-text">ุงุณุชุนุฏ...</div>
</div>

<!-- ๐น ุญุงููุฉ ุงููุนุจุฉ (ููุชุฌุงูุจ) -->
<div class="game-wrapper">

  <div id="system-message"></div>

  <div class="game-header">
    <div>
      <div class="label">ุงูุญุฑู ุงููุฎุตุต</div>
      <div class="challenge-letter" id="current-letter">?</div>
    </div>
    <div id="timer">00:00</div>
  </div>

  <div class="answer-grid">
    <div class="answer-box">
      <label>ุญููุงู <span id="mark-ุญููุงู"></span></label>
      <input id="ุญููุงู">
    </div>

    <div class="answer-box">
      <label>ุฌูุงุฏ <span id="mark-ุฌูุงุฏ"></span></label>
      <input id="ุฌูุงุฏ">
    </div>

    <div class="answer-box">
      <label>ูุจุงุช <span id="mark-ูุจุงุช"></span></label>
      <input id="ูุจุงุช">
    </div>

    <div class="answer-box">
      <label>ุจูุงุฏ <span id="mark-ุจูุงุฏ"></span></label>
      <input id="ุจูุงุฏ">
    </div>

    <div class="answer-box full">
      <label>ุงุณู <span id="mark-ุงุณู"></span></label>
      <input id="ุงุณู">
    </div>
  </div>

  <button id="stop-btn">ุชููู</button>
</div>

<!-- โ ุดุงุดุฉ ููุงูุฉ ุงูุฌููุฉ -->
<div id="end-round-overlay" class="end-overlay" style="display:none;">
  <div class="end-box">
    <h2>๐ ุงูุชูุช ุงูุฌููุฉ</h2>
    <p id="end-winner"></p>

    <div class="end-actions">
      <button id="play-again-btn">๐ ูุนุจ ูุฑุฉ ุซุงููุฉ</button>
      <button id="back-to-lobby-btn">โฌ๏ธ ุงูุนูุฏุฉ ููุบุฑูุฉ</button>
    </div>
  </div>
</div>

<script>
/* ===============================
   Socket & Data
================================ */
const socket = io();
const ROOM_CODE = new URLSearchParams(location.search).get("roomCode");
const playerName = localStorage.getItem("gameUsername");

if (!ROOM_CODE || !playerName) location.href = "index.html";

let timeRemaining = 0;
let timerInterval;
let gameRunning = false;
let currentLetter = "";

const stopBtn = document.getElementById("stop-btn");

/* ===============================
   Helpers
================================ */
function toggleInputs(disabled) {
  document.querySelectorAll(".answer-grid input").forEach(i => {
    i.disabled = disabled;
  });
}

function showMessage(text, color="#2980b9") {
  const m = document.getElementById("system-message");
  m.textContent = text;
  m.style.background = color;
  m.style.display = "block";
}

/* ===============================
   Connection
================================ */
socket.on("connect", () => {
  socket.emit("identify_player", { roomCode: ROOM_CODE, playerName });
});

/* ===============================
   Countdown
================================ */
socket.on("pre_game_countdown", n => {
  const overlay = document.getElementById("pre-game-overlay");
  overlay.style.display = "flex";
  document.getElementById("countdown-number").textContent =
    n === 0 ? "ุงุจุฏุฃ!" : n;
});

/* ===============================
   Start Game
================================ */
socket.on("game_actually_started", data => {
  document.getElementById("pre-game-overlay").style.display = "none";

  currentLetter = data.letter;
  timeRemaining = data.time;

  document.getElementById("current-letter").textContent = currentLetter;
  gameRunning = true;

  toggleInputs(false);
  startTimer();
});

/* ===============================
   Timer
================================ */
function startTimer() {
  clearInterval(timerInterval);

  timerInterval = setInterval(() => {
    if (!gameRunning) return;

    if (timeRemaining <= 0) {
      sendAnswers(true);
      return;
    }

    timeRemaining--;
    document.getElementById("timer").textContent =
      `00:${String(timeRemaining).padStart(2,"0")}`;
  }, 1000);
}

/* ===============================
   Send Answers
================================ */
function sendAnswers(auto=false) {
  if (!gameRunning && !auto) return;

  gameRunning = false;
  stopBtn.disabled = true;

  socket.emit("stop_game_request", {
    roomCode: ROOM_CODE,
    playerName,
    currentLetter,
    answers: {
      ุญููุงู: ุญููุงู.value,
      ุฌูุงุฏ: ุฌูุงุฏ.value,
      ูุจุงุช: ูุจุงุช.value,
      ุจูุงุฏ: ุจูุงุฏ.value,
      ุงุณู: ุงุณู.value
    }
  });

  showMessage("โณ ุฌุงุฑู ุงูุชุญูู...");
}

stopBtn.onclick = () => sendAnswers(false);

/* ===============================
   AI Correction
================================ */
socket.on("ai_correction", results => {
  for (const k in results) {
    const el = document.getElementById("mark-" + k);
    el.textContent = results[k] === "ุตุญ" ? "โ" : "โ";
  }
});

/* ===============================
   Stop Failed (ูุญุงููุฉ ุซุงููุฉ)
================================ */
socket.on("stop_failed", d => {
  showMessage(d.message, "#f39c12");
  gameRunning = true;
  stopBtn.disabled = false;
});

/* ===============================
   End Round
================================ */
socket.on("player_won_match", d => {
  toggleInputs(true);

  const overlay = document.getElementById("end-round-overlay");
  overlay.style.display = "flex";

  document.getElementById("end-winner").textContent =
    d.winner === playerName
      ? "๐ ุฃูุช ุงููุงุฆุฒ!"
      : `๐ ุงููุงุฆุฒ: ${d.winner}`;
});

/* ===============================
   Buttons
================================ */
document.getElementById("play-again-btn").onclick = () => {
  socket.emit("request_play_again", { roomCode: ROOM_CODE });
};

document.getElementById("back-to-lobby-btn").onclick = () => {
  location.href = `waiting.html?roomCode=${ROOM_CODE}`;
};

/* ===============================
   Init
================================ */
toggleInputs(true);
</script>

</body>
</html>
