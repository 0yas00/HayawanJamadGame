<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ© - Ø§Ù†ØªØ¸Ø§Ø±</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .settings-panel { background-color: #ecf0f1; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .setting-item { margin-bottom: 15px; }
        .setting-item label { display: block; font-weight: bold; margin-bottom: 5px; }
        #player-list li { 
            padding: 12px; 
            border-bottom: 1px solid #ddd; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: #fff;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .win-badge { 
            background: #f1c40f; 
            color: #2c3e50; 
            padding: 3px 10px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: bold; 
            border: 1px solid #d4ac0d;
        }
        .role-tag {
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
        }
        .creator-tag { background-color: #ffeaa7; color: #e67e22; border: 1px solid #fab1a0; }
        .member-tag { background-color: #dfe6e9; color: #636e72; border: 1px solid #b2bec3; }
        
        /* ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„Ø·Ø±Ø¯ */
        .kick-btn {
            background-color: #ff7675;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 10px;
            transition: 0.3s;
        }
        .kick-btn:hover { background-color: #d63031; }

        #settings-area { display: none; }
        .lobby-container { width: 500px; max-width: 95%; margin: 20px auto; }
    </style>
</head>
<body>
    <div class="lobby-container">
        <h2>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: <span id="room-code-display" style="color:#e74c3c;"></span></h2>
        
        <div id="player-list-container">
            <h3>ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ†:</h3>
            <ul id="player-list" style="list-style-type: none; padding: 0;">
                <li style="color: #7f8c8d; text-align: center;">Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</li>
            </ul>
        </div>

        <div id="settings-area" class="settings-panel">
            <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</h3>
            <div id="settings-controls">
                <div class="setting-item">
                    <label for="rounds-count">Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª (1-10):</label>
                    <input type="number" id="rounds-count" value="5" min="1" max="10" style="width: 100%; padding: 8px;">
                </div>
                <div class="setting-item">
                    <label for="round-time">Ù…Ø¯Ø© Ø§Ù„Ø¬ÙˆÙ„Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (30-180):</label>
                    <input type="number" id="round-time" value="90" min="30" max="180" style="width: 100%; padding: 8px;">
                </div>
                <button class="option-button" onclick="sendSettings()" style="width: 100%;">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
            <p id="settings-message" style="margin-top: 10px; text-align: center; color: #27ae60;"></p>
        </div>
        
        <button class="main-play-button" style="margin-top: 30px;" id="start-btn" onclick="startGame()">
            Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©
        </button>
        <p id="wait-message" style="text-align: center; color: #e67e22; margin-top: 15px; font-weight: bold;"></p>
    </div>

    <script>
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        const ROOM_CODE = getUrlParameter('roomCode');
        const playerName = localStorage.getItem('gameUsername') || 'Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„';
        
        if (!ROOM_CODE) window.location.href = 'index.html';
        document.getElementById('room-code-display').textContent = ROOM_CODE;
        
        const socket = io({ transports: ['websocket'] });

        socket.on('connect', () => {
            socket.emit('identify_player', { roomCode: ROOM_CODE, playerName: playerName });
        });

        socket.on('room_info', (data) => {
            const list = document.getElementById('player-list');
            list.innerHTML = ''; 

            const currentIsCreator = (data.creatorId === socket.id);

            data.players.forEach(p => {
                const item = document.createElement('li');
                const isCreator = (p.id === data.creatorId);
                const isMe = (p.id === socket.id);
                
                const roleLabel = isCreator ? 'Ø§Ù„Ù…Ù†Ø´Ø¦ ğŸ‘‘' : 'Ø¹Ø¶Ùˆ ğŸ‘¤';
                const roleClass = isCreator ? 'creator-tag' : 'member-tag';

                // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø·Ø±Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ù‡Ùˆ Ø§Ù„Ù…Ù†Ø´Ø¦ ÙˆØ§Ù„Ù‡Ø¯Ù Ù„ÙŠØ³ Ø§Ù„Ù…Ù†Ø´Ø¦ Ù†ÙØ³Ù‡
                let kickHtml = "";
                if (currentIsCreator && !isCreator) {
                    kickHtml = `<button class="kick-btn" onclick="kickPlayer('${p.id}', '${p.name}')">Ø·Ø±Ø¯ âŒ</button>`;
                }

                item.innerHTML = `
                    <div>
                        <strong style="${isCreator ? 'color: #e67e22;' : 'color: #2c3e50;'}">${p.name}</strong>
                        ${isMe ? '<span style="color: #27ae60; font-size: 11px;"> (Ø£Ù†Øª)</span>' : ''}
                        <span class="role-tag ${roleClass}">${roleLabel}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        ${kickHtml}
                        <span class="win-badge">ğŸ† ÙÙˆØ²: ${p.wins || 0}</span>
                    </div>
                `;
                list.appendChild(item);
            });

            const startBtn = document.getElementById('start-btn');
            const settingsArea = document.getElementById('settings-area');
            const waitMsg = document.getElementById('wait-message');

            if (currentIsCreator) {
                settingsArea.style.display = 'block';
                startBtn.disabled = false;
                startBtn.style.opacity = "1";
                startBtn.textContent = "Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰";
                waitMsg.textContent = "Ø£Ù†Øª Ø§Ù„Ù…Ù†Ø´Ø¦. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ Ø·Ø±Ø¯ Ø§Ù„Ù…ØªØ·ÙÙ„ÙŠÙ†.";
                document.getElementById('rounds-count').value = data.settings.rounds;
                document.getElementById('round-time').value = data.settings.time;
            } else {
                settingsArea.style.display = 'none';
                startBtn.disabled = true;
                startBtn.style.opacity = "0.6";
                startBtn.textContent = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù†Ø´Ø¦...";
                waitMsg.textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ù†Ø´Ø¦ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©.";
            }
        });

        // Ø¯Ø§Ù„Ø© Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨
        function kickPlayer(targetId, targetName) {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ "${targetName}"ØŸ`)) {
                socket.emit('kick_player', { roomCode: ROOM_CODE, targetId: targetId });
            }
        }

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø¯Ø« Ø§Ù„Ø·Ø±Ø¯ (Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ ØªÙ… Ø·Ø±Ø¯Ù‡)
        socket.on('you_are_kicked', () => {
            alert("Ù„Ù‚Ø¯ ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù†Ø´Ø¦.");
            window.location.href = 'index.html';
        });

        function sendSettings() {
            const rounds = document.getElementById('rounds-count').value;
            const time = document.getElementById('round-time').value;
            socket.emit('update_settings', { roomCode: ROOM_CODE, rounds: parseInt(rounds), time: parseInt(time) });
            document.getElementById('settings-message').textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…";
            setTimeout(() => { document.getElementById('settings-message').textContent = ""; }, 2000);
        }

        function startGame() {
            socket.emit('start_game', { roomCode: ROOM_CODE });
        }

        socket.on('game_started', (data) => {
            window.location.href = `game.html?roomCode=${data.roomCode}`;
        });
    </script>
</body>
</html>